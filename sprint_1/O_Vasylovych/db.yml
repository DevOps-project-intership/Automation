---

- name: Update db servers
  hosts: database
  remote_user: root
  become: yes

  vars:
    db_host: 192.168.56.111
    db_name: bird
    db_user: flask
    pg_allowed_net: 192.168.56.0/24
    pg_listen_ip: 192.168.56.110
    pg_conf_path: /etc/postgresql/16/main

  tasks:
    - name: Ensure PostgreSQL and psycopg2 are installed
      ansible.builtin.apt:
        name:
          - postgresql
          - postgresql-contrib
          - python3-psycopg2
        state: present
        update_cache: yes

    - name: Ensure PostgreSQL is running and enabled
      ansible.builtin.systemd:
        name: postgresql
        state: started
        enabled: true

    - name: Create database if not exists
      ansible.builtin.shell: |
        sudo -u postgres psql -tc "SELECT 1 FROM pg_database WHERE datname='{{ db_name }}'" | grep -q 1 \
        || sudo -u postgres psql -c "CREATE DATABASE {{ db_name }};"

    - name: Create database user with password if not exists
      ansible.builtin.shell: |
        sudo -u postgres psql -tc "SELECT 1 FROM pg_roles WHERE rolname='{{ db_user }}'" | grep -q 1 \
        || sudo -u postgres psql -c "CREATE USER {{ db_user }} WITH PASSWORD '{{ db_password }}';"

    - name: Grant ALL privileges on DB to user
      ansible.builtin.shell: |
        sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE {{ db_name }} TO {{ db_user }};"

    - name: Set listen_addresses in postgresql.conf
      ansible.builtin.shell: |
        sudo -u postgres sed -i "s/^#listen_addresses = .*/listen_addresses = '{{ pg_listen_ip }}'/" {{ pg_conf_path }}/postgresql.conf
      notify: Restart PostgreSQL

    - name: Add pg_hba rule
      ansible.builtin.shell: |
        grep -qxF "host all all {{ pg_allowed_net }} scram-sha-256" {{ pg_conf_path }}/pg_hba.conf \
        || echo "host all all {{ pg_allowed_net }} scram-sha-256" >> {{ pg_conf_path }}/pg_hba.conf
      notify: Restart PostgreSQL

  handlers:
    - name: Restart PostgreSQL
      ansible.builtin.systemd:
        name: postgresql
        state: restarted
